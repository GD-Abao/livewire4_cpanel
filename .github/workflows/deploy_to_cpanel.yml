name: 20260130Laravel+Livewire網站部署到cPanel

on:
  push:
    branches:
      - main

jobs:
  web-deploy:
    name: Deploy
    runs-on: ubuntu-latest

    steps:
      # 1) 取得程式碼
      - name: Get latest code
        uses: actions/checkout@v4

      # 2) 安裝 PHP + Composer（只在 CI 使用）
      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: "8.3"
          tools: composer:v2

      # 3) 安裝 Node（build 前端）
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "latest"
          cache: "npm"

      # 4) 安裝後端依賴（production）
      - name: Install Composer dependencies
        run: composer install --no-dev --optimize-autoloader

      # 5) 安裝前端依賴
      - name: Install npm dependencies
        run: npm ci

      # 6) 打包前端資產
      - name: Build project
        run: npm run build

      # 7) 由 .env.example 產生 .env.deploy，並注入 secrets
      - name: Prepare .env from .env.example
        env:
          APP_ENV: production
          APP_DEBUG: "false"
          APP_KEY: ${{ secrets.APP_KEY }}

          DB_CONNECTION: mysql
          DB_HOST: 127.0.0.1
          DB_PORT: "3306"
          DB_DATABASE: ${{ secrets.DB_DATABASE }}
          DB_USERNAME: ${{ secrets.DB_USERNAME }}
          DB_PASSWORD: ${{ secrets.DB_PASSWORD }}

          MAIL_MAILER: smtp
          MAIL_HOST: ${{ secrets.MAIL_HOST }}
          MAIL_PORT: "587"
          MAIL_USERNAME: ${{ secrets.MAIL_USERNAME }}
          MAIL_PASSWORD: ${{ secrets.MAIL_PASSWORD }}
          MAIL_FROM_ADDRESS: ${{ secrets.MAIL_USERNAME }}
        run: |
          cp .env.example .env.deploy
          python - <<'PY'
          import os, re

          path = ".env.deploy"
          with open(path, "r", encoding="utf-8") as f:
              lines = f.read().splitlines()

          def set_key(lines, key, value):
              if not value:
                  return lines
              pattern = re.compile(rf"^{re.escape(key)}=")
              out, found = [], False
              for line in lines:
                  if pattern.match(line):
                      out.append(f"{key}={value}")
                      found = True
                  else:
                      out.append(line)
              if not found:
                  out.append(f"{key}={value}")
              return out

          values = {
              "APP_ENV": os.getenv("APP_ENV"),
              "APP_DEBUG": os.getenv("APP_DEBUG"),
              "APP_KEY": os.getenv("APP_KEY"),
              "DB_CONNECTION": os.getenv("DB_CONNECTION"),
              "DB_HOST": os.getenv("DB_HOST"),
              "DB_PORT": os.getenv("DB_PORT"),
              "DB_DATABASE": os.getenv("DB_DATABASE"),
              "DB_USERNAME": os.getenv("DB_USERNAME"),
              "DB_PASSWORD": os.getenv("DB_PASSWORD"),
              "MAIL_MAILER": os.getenv("MAIL_MAILER"),
              "MAIL_HOST": os.getenv("MAIL_HOST"),
              "MAIL_PORT": os.getenv("MAIL_PORT"),
              "MAIL_USERNAME": os.getenv("MAIL_USERNAME"),
              "MAIL_PASSWORD": os.getenv("MAIL_PASSWORD"),
              "MAIL_FROM_ADDRESS": os.getenv("MAIL_FROM_ADDRESS"),
          }

          for k, v in values.items():
              lines = set_key(lines, k, v)

          with open(path, "w", encoding="utf-8") as f:
              f.write("\n".join(lines) + "\n")
          PY

      # 8) 移除不需上傳的檔案
      - name: Prune deploy files
        run: |
          rm -rf node_modules .git .github tests

      # 9) 上傳到主機（完整專案，含 vendor / public build）
      - name: Deploy via SCP
        uses: appleboy/scp-action@v0.1.4
        with:
          host: ${{ secrets.SSH_HOST }}
          port: ${{ secrets.SSH_PORT }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_KEY }}
          source: "./"
          target: ${{ secrets.SITE_PATH }}

      # 10) 主機端處理（不跑 composer）
      - name: SSH Execute Commands (Finalize)
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SSH_HOST }}
          port: ${{ secrets.SSH_PORT }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_KEY }}
          script: |
            set -e

            SITE_PATH="${{ secrets.SITE_PATH }}"

            mkdir -p "$SITE_PATH"
            cd "$SITE_PATH"

            # 防呆：確認 Laravel 根目錄
            if [ ! -f artisan ]; then
              echo "ERROR: artisan not found in SITE_PATH=$SITE_PATH"
              echo "PWD=$(pwd)"
              ls -la
              exit 1
            fi

            # .env.deploy → .env
            if [ -f .env.deploy ]; then
              mv .env.deploy .env
              chmod 600 .env || true
            fi

            # storage link（不用 artisan）
            rm -rf public/storage
            ln -sfn "$SITE_PATH/storage/app/public" "$SITE_PATH/public/storage"

            # 清快取
            if command -v php >/dev/null 2>&1; then
              php artisan config:clear || true
              php artisan route:clear  || true
              php artisan view:clear   || true
              php artisan cache:clear  || true
            fi

            # 清理殘留檔案
            rm -rf .git .github node_modules || true
            rm -f "$HOME"/*.tar.gz || true
